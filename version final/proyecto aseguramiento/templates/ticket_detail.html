<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Detalle del Ticket</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    .notifications { margin: 4px auto; padding: 0 16px; max-width: 1000px; }
    .alert { font-size: 0.8rem; padding: 4px 8px; margin-bottom: 4px; border-radius: 4px; text-align: center; opacity: 1; transition: opacity 0.3s ease-out; }
    .alert.hide { opacity: 0; }
    .alert.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .alert.error   { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

    .notif-icon { position: relative; display: inline-block; font-size: 18px; color: #007bff; margin-left: 16px; }
    .notif-icon .badge { position: absolute; top: -6px; right: -10px; background: #dc3545; color: #fff; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; }

    .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background-color: #e9f7fe; font-weight: bold; }
    .header-right { display: flex; align-items: center; gap: 10px; }
    .logout { margin-left: 10px; }

    .ticket-detail { max-width: 900px; margin: 20px auto; padding: 20px; background: #fff; border-radius: 10px; box-shadow: 0 0 6px rgba(0,0,0,.1); }
    .ticket-detail h2 { margin-bottom: 8px; color: #333; }
    .muted { color:#666; font-size:.92rem; }

    .ticket-info p { margin: 6px 0; font-size: 0.95rem; }
    .ticket-history { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
    .ticket-history h3 { font-size: 1.05rem; margin-bottom: 8px; }
    .ticket-history ul { list-style: none; padding: 0; }
    .ticket-history li { font-size: 0.92rem; margin-bottom: 6px; }
    em { color:#1f6feb; }

    .btn { display:inline-block; margin: 12px 0; padding: 8px 12px; border-radius: 6px; background:#007bff; color:#fff; text-decoration:none; border:none; }
    .btn:hover { background:#0056b3; }
    .btn-gray { background:#eceff4; color:#333; }
  </style>
</head>
<body class="bg-white">

  <!-- Notificaciones Flash -->
  <div class="notifications">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% for category, msg in messages %}
        <div class="alert {{ category }}">{{ msg }}</div>
      {% endfor %}
    {% endwith %}
  </div>

  <!-- Cabecera -->
  <header class="header">
    <div>{{ first_name }} {{ last_name }}</div>
    <div class="header-right">
      <div class="notif-icon">
        <a href="{{ url_for('notifications_view') }}">üîî
          {% if notif_count and notif_count > 0 %}
            <span class="badge">{{ notif_count }}</span>
          {% endif %}
        </a>
      </div>
      <a href="{{ url_for('dashboard') }}" class="btn btn-gray">‚Üê Volver al panel</a>
      <a href="{{ url_for('logout') }}" class="btn">Salir</a>
    </div>
  </header>

  <main class="main">
    <section class="ticket-detail">
      <h2>Ticket: {{ ticket.tema }}</h2>
      <div class="muted">ID: {{ ticket._id }} ¬∑ Cliente: {{ ticket.cliente }}</div>

      <div class="ticket-info">
        <p><strong>Estado:</strong> {{ ticket.status|capitalize }}</p>
        <p><strong>Prioridad:</strong> {{ ticket.priority|default('media')|capitalize }}</p>
        <p><strong>Asignado a:</strong> {{ ticket.asignado_a or "‚Äî" }}</p>
        <p><strong>Descripci√≥n:</strong> {{ ticket.descripcion }}</p>
      </div>

      {% if ticket.history %}
        <div class="ticket-history">
          <h3>Historial</h3>
          <ul>
            {% for h in ticket.history %}
              <li>
                {{ h.actor }} {{ h.action }}
                {% if h.solution %} ‚Äî <em>Soluci√≥n:</em> {{ h.solution }}{% endif %}
                {% if h.at %} ‚Äî {{ h.at.strftime('%d/%m/%Y %H:%M') }}{% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    </section>
  </main>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const alerts = document.querySelectorAll('.alert');
      if (!alerts.length) return;
      setTimeout(() => alerts.forEach(a => a.classList.add('hide')), 2500);
    });
  </script>
</body>
</html>
