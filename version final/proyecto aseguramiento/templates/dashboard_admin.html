<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Admin ‚Äî Tickets</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    /* Alertas compactas */
    .notifications { margin:4px auto; padding:0 16px; max-width:1000px; }
    .alert {
      font-size:0.8rem; padding:4px 8px; margin-bottom:4px;
      border-radius:4px; text-align:center; opacity:1;
      transition:opacity 0.3s ease-out;
    }
    .alert.hide { opacity:0; }
    .alert.success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .alert.error   { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }

    /* Icono notificaciones */
    .notif-icon {
      position: relative; display: inline-block; margin-right:8px; font-size:1.1rem;
    }
    .notif-icon .badge {
      position:absolute; top:-6px; right:-10px;
      background:#dc3545; color:#fff; border-radius:50%;
      padding:2px 6px; font-size:0.7rem;
    }

    /* Bot√≥n primario mini (por si tu style.css no lo define) */
    .btn-primary {
      display:inline-block; background:#0d6efd; color:#fff; text-decoration:none;
      padding:6px 10px; border-radius:6px; border:0; cursor:pointer; font-weight:600;
    }
    .btn-primary:hover { background:#0b5ed7; }

    /* Chips de estado (opcionales) */
    .chip{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:.8rem; }
    .chip.orange{ background:#fff3cd; color:#8a6d3b; border:1px solid #ffe69c; }
    .chip.gray{ background:#f0f0f0; color:#555; border:1px solid #e2e2e2; }
    .chip.green{ background:#e6f4ea; color:#1e7e34; border:1px solid #c8e6c9; }

    /* Inputs de tabla */
    .mini-input { font-size:0.8rem; padding:2px 4px; }
  </style>
</head>
<body class="bg-white">

  <!-- Notificaciones flash -->
  <div class="notifications">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% for category, msg in messages %}
        <div class="alert {{ category }}">{{ msg }}</div>
      {% endfor %}
    {% endwith %}
  </div>

  <header class="header">
    <div>Admin: {{ first_name }} {{ last_name }}</div>

    <div style="display:flex; align-items:center; gap:10px;">
      <!-- Campanita -->
      <div class="notif-icon">
        <a href="{{ url_for('notifications_view') }}">üîî
          {% if notif_count and notif_count > 0 %}
            <span class="badge">{{ notif_count }}</span>
          {% endif %}
        </a>
      </div>

      <!-- Bot√≥n para ir a Resolver Tickets -->
      <a href="{{ url_for('admin_resolver') }}" class="btn-primary">‚öôÔ∏è Resolver tickets</a>

      <a href="{{ url_for('logout') }}" class="logout">Salir</a>
    </div>
  </header>

  <main class="main">
    <!-- Usuarios registrados -->
    <section class="card" style="flex:1;">
      <h2>Usuarios</h2>
      <table class="admin-table">
        <thead>
          <tr><th>#</th><th>Usuario</th><th>Rol</th><th>Registro</th><th>G√©nero</th></tr>
        </thead>
        <tbody>
          {% for u in users %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ u.username }}</td>
              <td>{{ u.role }}</td>
              <td>{{ u.registered_at or '‚Äî' }}</td>
              <td>{{ u.gender or '‚Äî' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <!-- Crear nuevo t√©cnico -->
    <section class="card" style="flex:1;">
      <h2>A√±adir T√©cnico</h2>
      <form method="post">
        <input name="new_support_username" placeholder="Usuario" required><br>
        <input name="new_support_password" placeholder="Contrase√±a" type="password" required><br>
        <button class="btn-primary" type="submit">Crear T√©cnico</button>
      </form>
    </section>

    <!-- Todos los tickets -->
    <section class="card" style="flex:2;">
      <h2>Tickets</h2>
      <table class="admin-table">
        <thead>
          <tr><th>#</th><th>Tema</th><th>Status</th><th>Prioridad</th><th>Asignado</th><th>Acciones</th></tr>
        </thead>
        <tbody>
          {% for t in tickets %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ t.tema }}</td>
              <td>
                {% if t.status == 'en progreso' %}
                  <span class="chip orange">En progreso</span>
                {% elif t.status == 'abierto' %}
                  <span class="chip gray">Abierto</span>
                {% elif t.status == 'resuelto' %}
                  <span class="chip green">Resuelto</span>
                {% else %}
                  {{ t.status }}
                {% endif %}
              </td>
              <td>{{ t.priority }}</td>
              <td>{{ t.asignado_a or '‚Äî' }}</td>
              <td>
                <form method="post" style="display:flex;gap:4px;align-items:center; flex-wrap:wrap;">
                  <input type="hidden" name="ticket_id" value="{{ t._id }}">
                  <select name="priority" class="mini-input">
                    <option value="alta"   {% if t.priority=='alta'  %}selected{% endif %}>Alta</option>
                    <option value="media"  {% if t.priority=='media' %}selected{% endif %}>Media</option>
                    <option value="baja"   {% if t.priority=='baja'  %}selected{% endif %}>Baja</option>
                  </select>
                  <select name="agent" class="mini-input">
                    <option value="">Agente‚Ä¶</option>
                    {% for a in agents %}<option {% if t.asignado_a==a %}selected{% endif %}>{{ a }}</option>{% endfor %}
                  </select>
                  <button name="action" value="asignar" class="btn-primary">Asignar</button>
                  {% if t.status!='resuelto' %}
                    <button name="action" value="resolver" class="btn-primary" style="background:#198754;">Resolver</button>
                  {% endif %}
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <!-- Acceso al Asistente Virtual -->
    <section class="card" style="flex:1; text-align:center;">
      <a href="{{ url_for('experto_page') }}" class="btn-primary">üí¨ Consultar al Asistente Virtual</a>
    </section>
  </main>

  <!-- Auto-ocultar alertas flash -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const alerts = document.querySelectorAll('.alert');
      if (!alerts.length) return;
      setTimeout(() => alerts.forEach(a => a.classList.add('hide')), 2500);
    });
  </script>
</body>
</html>
